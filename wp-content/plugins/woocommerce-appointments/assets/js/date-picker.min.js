var HOUR_OFFSET=12;let wc_appointments_date_picker={};jQuery(function(c){"use strict";var m,f,i,E={},t=window.navigator.userLanguage||window.navigator.language,o={init:function(){c("body").on("change","#wc_appointments_field_staff",this.staff_calendar),c("body").on("click",".wc-appointments-date-picker legend small.wc-appointments-date-picker-choose-date",this.toggle_calendar),c("body").on("click",".appointment_date_year, .appointment_date_month, .appointment_date_day",this.open_calendar),c("body").on("input",".appointment_date_year, .appointment_date_month, .appointment_date_day",this.input_date_trigger),c("body").on("change",".appointment_to_date_year, .appointment_to_date_month, .appointment_to_date_day",this.input_date_trigger),c(".wc-appointments-date-picker legend small.wc-appointments-date-picker-choose-date").show(),c(".wc-appointments-date-picker").each(function(){var n=c(this).closest("form"),s=n.find(".picker:eq(0)"),t=c(this).closest("fieldset"),e=s.attr("data-duration_unit");-1===c.inArray(e,["minute","hour"])&&n.on("addon-duration-changed",function(t,e){var a=parseInt(s.attr("data-appointment_duration"),10),i=parseInt(e,10),a=parseInt(a+i,10);s.data("combined_duration",a),s.data("addon_duration",e),wc_appointments_date_picker.highlight_days(n)}),wc_appointments_date_picker.date_picker_init(s),c(".wc-appointments-date-picker-date-fields",t).hide(),c(".wc-appointments-date-picker-choose-date",t).hide()})},highlight_days:function(t){var t=t.find(".picker"),e=t.find("td.ui-datepicker-current-day").not(".ui-state-disabled"),a=t.attr("data-appointment_duration"),a=t.data("combined_duration")?t.data("combined_duration"):a,a=(a<1?1:a)-1;t.find("td").removeClass("ui-datepicker-selected-day"),0<a&&e.nextAll("td").add(e.closest("tr").nextAll().find("td")).slice(0,a).addClass("ui-datepicker-selected-day")},staff_calendar:function(){var t=c(this).closest("form").find(".picker:eq(0)");wc_appointments_date_picker.date_picker_init(t)},toggle_calendar:function(){var t=c(this).closest("fieldset").find(".picker:eq(0)");wc_appointments_date_picker.date_picker_init(t),t.slideToggle()},open_calendar:function(){var t=c(this).closest("fieldset").find(".picker:eq(0)");wc_appointments_date_picker.date_picker_init(t),t.slideDown()},input_date_trigger:function(){var t=c(this).closest("fieldset"),e=t.find(".picker:eq(0)"),a=parseInt(t.find("input.appointment_date_year").val(),10),i=parseInt(t.find("input.appointment_date_month").val(),10),t=parseInt(t.find("input.appointment_date_day").val(),10);a&&i&&t&&(a=new Date(a,i-1,t),e.datepicker("setDate",a))},select_date_trigger:function(t){var e=c(this).closest("fieldset"),a=e.closest("form"),i=a.find(".picker:eq(0)"),n=t.split("-"),s=parseInt(n[0],10),r=parseInt(n[1],10),d=parseInt(n[2],10),_=i.attr("data-duration_unit"),o=i.attr("data-appointment_duration"),i=i.data("combined_duration")?i.data("combined_duration"):o;-1===c.inArray(_,["minute","hour"])&&(o=i<1?1:i,m=new Date(s,r-1,d),f=new Date(s,r-1,d+(parseInt(o,10)-1))),e.find("input.appointment_to_date_year").val(""),e.find("input.appointment_to_date_month").val(""),e.find("input.appointment_to_date_day").val(""),e.find("input.appointment_date_year").val(n[0]),e.find("input.appointment_date_month").val(n[1]),e.find("input.appointment_date_day").val(n[2]).trigger("change"),a.find(".wc-appointments-appointment-form-button").prop("disabled",!0),a.triggerHandler("date-selected",t)},date_picker_init:function(a){var t=new i(a),e=t.get_data_attr("default_date");null!==wca_get_querystring("date")&&wca_is_valid_date(wca_get_querystring("date"))&&(e=wca_get_querystring("date")),t.set_default_params({onSelect:wc_appointments_date_picker.select_date_trigger,minDate:t.get_data_attr("min_date"),maxDate:t.get_data_attr("max_date"),defaultDate:e,changeMonth:t.get_custom_data("changeMonth"),changeYear:t.get_custom_data("changeYear"),showWeek:t.get_custom_data("showWeek"),showOn:t.get_custom_data("showOn"),numberOfMonths:parseInt(t.get_custom_data("numberOfMonths")),showButtonPanel:t.get_custom_data("showButtonPanel"),showOtherMonths:t.get_custom_data("showOtherMonths"),selectOtherMonths:t.get_custom_data("selectOtherMonths"),gotoCurrent:t.get_custom_data("gotoCurrent"),closeText:t.get_custom_data("closeText"),currentText:t.get_custom_data("currentText"),prevText:t.get_custom_data("prevText"),nextText:t.get_custom_data("nextText"),monthNames:t.get_custom_data("monthNames"),monthNamesShort:t.get_custom_data("monthNamesShort"),dayNames:t.get_custom_data("dayNames"),dayNamesMin:t.get_custom_data("dayNamesShort"),firstDay:t.get_custom_data("firstDay"),isRTL:t.get_custom_data("isRTL"),beforeShowDay:t.maybe_load_from_cache.bind(t),onChangeMonthYear:function(t,e){this.get_data(t,e).done(function(){a.datepicker("refresh")})}.bind(t)}),t.create(),wc_appointments_date_picker.get_day_attributes=t.maybe_load_from_cache.bind(t)},refresh_datepicker:function(){c(".wc-appointments-date-picker").find(".picker:eq(0)").datepicker("refresh")},get_number_of_days:function(t,e,a){var i=a.attr("data-duration_unit"),n=a.attr("data-appointment_duration"),n=a.data("combined_duration")?a.data("combined_duration"):n,a=a.attr("data-availability_span");return t=(t=-1===c.inArray(i,["minute","hour"])?n<1?1:n:t)<1||"start"===a?1:t},is_slot_appointable:function(t){for(var e=t.default_availability,a=0;a<t.number_of_days;a++){var i=new Date(t.start_date),n=(i.setDate(i.getDate()+a),i.getFullYear()),s=i.getMonth()+1,r=i.getDate(),n=(i.getDay(),n+"-"+s+"-"+r),s={date:i,staff_id:t.staff_id,default_availability:t.default_availability,availability:t.availability};if(e=wc_appointments_date_picker.is_staff_available_on_date(s),"all"===t.staff_assignment&&t.has_staff&&1<t.has_staff?(r=c.extend({availability:t.availability,fully_scheduled_days:t.fully_scheduled_days},s),e=wc_appointments_date_picker.has_all_available_staff(r)):0===t.staff_id&&t.has_staff&&1<t.has_staff&&(i=c.extend({availability:t.availability,fully_scheduled_days:t.fully_scheduled_days,staff_count:t.has_staff,has_staff_ids:t.has_staff_ids},s),e=wc_appointments_date_picker.has_any_available_staff(i)),!(e=t.fully_scheduled_days[n]&&(t.fully_scheduled_days[n][0]||t.fully_scheduled_days[n][t.staff_id])?!1:e))break}return e},rrule_cache:{},is_staff_available_on_date:function(F){if("object"!=typeof F||"object"!=typeof F.availability)return!1;var t=F.default_availability,P=F.date.getFullYear(),Y=F.date.getMonth()+1,T=F.date.getDate(),j=F.date.getDay(),e=P+"-"+Y+"-"+T,q=parseInt(F.staff_id),S=moment.utc(F.date).isoWeek(),A=(0===j&&(j=7),[]);if(F.fully_scheduled_days&&F.fully_scheduled_days[e]&&F.fully_scheduled_days[e][q])return A;var C=_.range(1,1440,1);return t&&(A=C),c.each(F.availability,function(t,e){var a=e.type,n=e.range,i=e.level,e=parseInt(e.kind_id);if(Array.isArray(n))return!0;if(void 0!==q&&q&&0!==q&&"staff"===i&&q!==e)return!0;try{switch(a){case"months":if("undefined"!=typeof n[Y])return A=n[Y]?C:[],!0;break;case"weeks":if("undefined"!=typeof n[S])return A=n[S]?C:[],!0;break;case"days":if("undefined"!=typeof n[j])return A=n[j]?C:[],!0;break;case"custom":if("undefined"!=typeof n[P][Y][T])return A=n[P][Y][T]?C:[],!0;break;case"rrule":var s=-1===n.from.indexOf(":"),r=moment.utc(F.date).clone().startOf("day"),d=moment.utc(n.from),o=s?moment.utc(n.to).add(1,"days"):moment.utc(n.to),c=moment.duration(o.diff(d)),p=rrule.rrulestr(n.rrule,{dtstart:d.toDate()}),l=t+E.startDate+E.endDate;"undefined"==typeof wc_appointments_date_picker.rrule_cache[l]&&(wc_appointments_date_picker.rrule_cache[l]=p.between(moment.utc(E.startDate).subtract(c).subtract(1,"days").toDate(),moment.utc(E.endDate).subtract(c).add(1,"days").toDate(),!0).map(function(t){return new moment(t)})),wc_appointments_date_picker.rrule_cache[l].forEach(function(t){var e=t.clone().startOf("day"),a=t.clone().add(c),i=a.clone().startOf("day");r.isSameOrAfter(e)&&r.isBefore(i)&&(s?A=n.rule?C:[]:r.isSame(e)?(t=moment.duration(t.diff(e)).asMinutes(),I=_.range(t,t+c.asMinutes(),1),A=n.rule?_.union(A,I):_.difference(A,I)):r.isAfter(e)&&r.isBefore(i)?A=n.rule?C:[]:r.isSame(i)&&(I=_.range(1,moment.duration(a.diff(i)).asMinutes(),1),A=n.rule?_.union(A,I):_.difference(A,I)))});break;case"time":case"time:1":case"time:2":case"time:3":case"time:4":case"time:5":case"time:6":case"time:7":var u=parseInt(n.from.split(":")[0]),m=parseInt(n.from.split(":")[1])+60*u,f=parseInt(n.to.split(":")[0]),h=parseInt(n.to.split(":")[1]),y=h+60*f,g=!1,b=0==j-1?7:j-1;if(!(0===f&&0===h)&&y<=m&&n.day===b&&(g=n.day),j===n.day||0===n.day||g===n.day)return y<=m&&(y=h+60*(f+=24)),I=_.range(m,y,1),A=n.rule?_.union(A,I):_.difference(A,I),!0;break;case"time:range":case"custom:daterange":var n=n[P][Y][T],D=parseInt(n.from.split(":")[0]),k=parseInt(n.from.split(":")[1]),w=parseInt(n.to.split(":")[0]),v=parseInt(n.to.split(":")[1]),x=(w<=D&&v<=k&&(w+=24),k+60*D),M=v+60*w,I=_.range(x,M,1);A=n.rule?_.union(A,I):_.difference(A,I)}}catch(O){return!0}}),!_.isEmpty(A)},get_week_number:function(t){return moment(t).format("W")},has_all_available_staff:function(i){var n=[];return"object"==typeof i&&"object"==typeof i.availability&&(c.each(i.availability,function(t,e){var a=e.level,e=parseInt(e.kind_id);if("staff"!==a||!e)return!0;i.staff_id=e,wc_appointments_date_picker.is_staff_available_on_date(i)||n.push(!1)}),!n.includes(!1))},has_any_available_staff:function(a){var i=[];return"object"==typeof a&&"object"==typeof a.availability&&(c.each(a.has_staff_ids,function(t,e){a.staff_id=e,wc_appointments_date_picker.is_staff_available_on_date(a)&&i.push(!0)}),!!i.includes(!0))},get_format_date:function(t){return t.getFullYear()+"-"+((t.getMonth()+1<10?"0":"")+(t.getMonth()+1))+"-"+((t.getDate()<10?"0":"")+t.getDate())},get_relative_date:function(t){for(var e=new Date,a=/([+-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,i=a.exec(t);i;){switch(i[2]||"d"){case"d":case"D":e.setDate(e.getDate()+parseInt(i[1],10));break;case"w":case"W":e.setDate(7*(e.getDate()+parseInt(i[1],10)));break;case"m":case"M":e.setMonth(e.getMonth()+parseInt(i[1],10));break;case"y":case"Y":e.setYear(e.getFullYear()+parseInt(i[1],10))}i=a.exec(t)}return e},find_available_date_within_month:function(){var a=[];return c.each(c(".appointable:not(.ui-state-disabled)").find(".ui-state-default"),function(t,e){e=+c(e).text();e&&a.push(e)}),a[0]},filter_selectable_day:function(t,e){return t.filter(function(){return Number(c(this).text())===e})}};(i=function i(t){this.customPicker=c(t),this.customForm=this.customPicker.closest("form, .cart"),this.customData={},this.opts={cache:!1},this.cache={data:{},attributes:{}},c.each(wc_appointment_form_params,function(t,e){this.customData[t]=e}.bind(this)),!this.customData.cache_ajax_requests||"true"!==this.customData.cache_ajax_requests.toLowerCase()&&"false"!==this.customData.cache_ajax_requests.toLowerCase()||(this.opts.cache="true"===this.customData.cache_ajax_requests.toLowerCase())}).prototype.create=function(){var t=parseInt(this.customForm.find("input.appointment_date_year").val(),10),e=parseInt(this.customForm.find("input.appointment_date_month").val(),10),a=parseInt(this.customForm.find("input.appointment_date_day").val(),10),i=this.get_default_date(),t=(this.customPicker.empty().removeClass("hasDatepicker").datepicker(this.get_default_params()),t&&e&&a&&this.customPicker.datepicker("setDate",new Date(t,e-1,a)),this.customPicker.datepicker("getDate").getFullYear()),e=this.customPicker.datepicker("getDate").getMonth()+1;this.get_data(t,e).done(function(){wc_appointments_date_picker.refresh_datepicker()}).done(function(){var t,e=this.customPicker.attr("data-is_autoselect");if(null===wca_get_querystring("date")&&e||null!==wca_get_querystring("date")&&wca_is_valid_date(wca_get_querystring("date")))if(this.customPicker.datepicker("refresh"),this.customPicker.find(".ui-datepicker-current-day").hasClass("ui-datepicker-unselectable")&&this.customPicker.datepicker("setDate",new Date(i.getFullYear(),i.getMonth()-1,1)),(e=this.customPicker.find(".ui-datepicker-current-day")).hasClass("ui-datepicker-unselectable"))for(var a=1;a<12;a++){if(t=wc_appointments_date_picker.find_available_date_within_month(),0<(t=wc_appointments_date_picker.filter_selectable_day(c(".ui-state-default"),t)).length){t.trigger("click");break}this.customPicker.find(".ui-datepicker-next").trigger("click")}else e.trigger("click");else c(".ui-datepicker-current-day").removeClass("ui-datepicker-current-day")})},i.prototype.maybe_load_from_cache=function(t){var e=t.getTime(),a=[!1,"1"===this.customData.default_availability?"appointable":"not-appointable",""],e=this.cache.attributes[e];return e?e=[e.selectable,e["class"].join(" "),e.title]:this.appointmentsData&&((t=new Date(t)).setHours(HOUR_OFFSET),a=[(t=this.getDateElementAttributes(t)).selectable,t["class"].join(" "),t.title]),e||a},i.prototype.get_default_params=function(){return this.defaultParams||{}},i.prototype.set_default_params=function(t){var e={showWeek:!1,showOn:!1,numberOfMonths:1,showButtonPanel:!1,showOtherMonths:!0,selectOtherMonths:!0,gotoCurrent:!0,dateFormat:c.datepicker.ISO_8601};if("object"!=typeof t)throw new Error("Cannot set params with typeof "+typeof t);this.defaultParams=c.extend(e,t)||{}},i.prototype.get_data=function(a,i){var t,e,n=function n(t){t=t||new Date([a,i,"01"].join("/"));var e=this.get_number_of_days_in_month(i);return this.get_padded_date_range(t,e)}.bind(this),s=c.Deferred(),r=n(),d=r.startDate.getTime()+"-"+r.endDate.getTime();return E=r,this.opts.cache&&this.cache.data[d]?s.resolveWith(this,[r,this.cache.data[d]]):(t={"wc-ajax":"wc_appointments_find_scheduled_day_slots",product_id:this.customPicker.attr("data-product_id"),security:this.get_custom_data("nonce_find_day_slots")},this.customPicker.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),t.min_date=moment(r.startDate).format("YYYY-MM-DD"),t.max_date=moment(r.endDate).format("YYYY-MM-DD"),(e=0<this.customForm.find("select#wc_appointments_field_staff").val()?this.customForm.find("select#wc_appointments_field_staff").val():0)&&0!==e&&(t.set_staff_id=e),c.ajax({context:this,url:wc_appointments_date_picker_args.ajax_url,method:"POST",data:t}).done(function(t){this.appointmentsData=this.appointmentsData||{},c.each(t,function(t,e){var a;Array.isArray(e)||"object"==typeof e?(a=Array.isArray(e)?[]:{},this.appointmentsData[t]=this.appointmentsData[t]||a,c.extend(this.appointmentsData[t],e)):this.appointmentsData[t]=e}.bind(this)),o.appointmentsData=this.appointmentsData,this.cache.data[d]=t,a||i||!this.appointmentsData.min_date||(r=n(this.get_default_date(this.appointmentsData.min_date))),s.resolveWith(this,[r,t]),this.customPicker.unblock(),this.customForm.triggerHandler("calendar-data-loaded",[this.appointmentsData,r])}.bind(this))),s},i.prototype.get_default_date=function(t){var e=this.customPicker.data("default_date").split("-"),a=(e[2]="31",1),e=3!==e.length?new Date:new Date(e);if(t){switch(t.unit){case"month":a=30;break;case"week":a=7}a*=t.value,e.setDate(e.getDate()+a)}return e},i.prototype.get_number_of_days_in_month=function(t){var e=this.get_default_date();return t=t||e.getMonth()+1,new Date(e.getFullYear(),t,0).getDate()},i.prototype.get_custom_data=function(t){if(t)return this.customData[t]||null},i.prototype.get_data_attr=function(t){if(t)return this.customPicker.data(t)},i.prototype.get_padded_date_range=function(t,e,a){t=t||this.get_default_date(),e=e||30,a=a||7;var i=new Date,n=t<i,t=new Date(t.setDate(n?i.getDate():"01")),s=new Date(t.getTime());return t.setDate(t.getDate()-(n?0:a)),s.setDate(s.getDate()+(e+a)),{startDate:t=t<i?i:t,endDate:s}},i.prototype.getDateElementAttributes=function(t){var e={"class":[],title:"",selectable:!0},a=0<this.customForm.find("select#wc_appointments_field_staff").val()?this.customForm.find("select#wc_appointments_field_staff").val():0,i=t.getFullYear(),n=t.getMonth()+1,s=t.getDate(),r=t.getDay(),d=new Date(t),_=new Date,o=_.getFullYear(),c=_.getMonth()+1,_=_.getDate(),p=i+"-"+n+"-"+s,l=this.customPicker.datepicker("option","minDate"),u=wc_appointments_date_picker.get_relative_date(l);if(e["class"].push("weekday-"+r),void 0!==m&&void 0!==f&&(m.setHours(HOUR_OFFSET),f.setHours(HOUR_OFFSET)),m<=t&&t<=f&&(e["class"].push("highlighted_day"),e["class"].push("ui-datepicker-selected-day")),wc_appointments_date_picker.get_format_date(d)<wc_appointments_date_picker.get_format_date(u)&&0!==parseInt(l)&&(e.title=wc_appointment_form_params.i18n_date_unavailable,e.selectable=!1,e["class"].push("not_appointable")),this.appointmentsData.unavailable_days&&this.appointmentsData.unavailable_days[p]&&this.appointmentsData.unavailable_days[p][a]&&(e.title=wc_appointment_form_params.i18n_date_unavailable,e.selectable=!1,e["class"].push("not_appointable")),this.appointmentsData.padding_days&&this.appointmentsData.padding_days[p]&&(this.appointmentsData.padding_days[p][0]||this.appointmentsData.padding_days[p][a])&&(e.title=wc_appointment_form_params.i18n_date_unavailable,e.selectable=!1,e["class"].push("not_appointable")),this.appointmentsData.restricted_days&&undefined===this.appointmentsData.restricted_days[r]&&(e.title=wc_appointment_form_params.i18n_date_unavailable,e.selectable=!1,e["class"].push("not_appointable")),""+i+n+s<wc_appointment_form_params.current_time&&(e.title=wc_appointment_form_params.i18n_date_unavailable,e.selectable=!1,e["class"].push("not_appointable")),this.appointmentsData.fully_scheduled_days[p]){if(this.appointmentsData.fully_scheduled_days[p][0]||this.appointmentsData.fully_scheduled_days[p][a])return e.title=wc_appointment_form_params.i18n_date_fully_scheduled,e.selectable=!1,e["class"].push("fully_scheduled"),e;"automatic"===this.appointmentsData.staff_assignment&&e["class"].push("partial_scheduled")}this.appointmentsData.partially_scheduled_days&&this.appointmentsData.partially_scheduled_days[p]&&(("automatic"===this.appointmentsData.staff_assignment||this.appointmentsData.has_staff&&0===a||this.appointmentsData.partially_scheduled_days[p][0]||this.appointmentsData.partially_scheduled_days[p][a])&&e["class"].push("partial_scheduled"),this.appointmentsData.remaining_scheduled_days[p]&&this.appointmentsData.remaining_scheduled_days[p][0]?e["class"].push("remaining_scheduled_"+this.appointmentsData.remaining_scheduled_days[p][0]):this.appointmentsData.remaining_scheduled_days[p]&&this.appointmentsData.remaining_scheduled_days[p][a]&&e["class"].push("remaining_scheduled_"+this.appointmentsData.remaining_scheduled_days[p][a])),new Date(i,n,s)<new Date(o,c,_)&&e["class"].push("past_day");d={start_date:t,number_of_days:wc_appointments_date_picker.get_number_of_days(this.appointmentsData.appointment_duration,this.customForm,this.customPicker),fully_scheduled_days:this.appointmentsData.fully_scheduled_days,availability:this.appointmentsData.availability_rules,default_availability:this.appointmentsData.default_availability,has_staff:this.appointmentsData.has_staff,has_staff_ids:this.appointmentsData.has_staff_ids,staff_id:a,staff_assignment:this.appointmentsData.staff_assignment},u=wc_appointments_date_picker.is_slot_appointable(d);return u?(-1<e["class"].indexOf("partial_scheduled")?e.title=wc_appointment_form_params.i18n_date_partially_scheduled:-1<e["class"].indexOf("past_day")?e.title=wc_appointment_form_params.i18n_date_unavailable:e.title=wc_appointment_form_params.i18n_date_available,e["class"].push("appointable")):(e.title=wc_appointment_form_params.i18n_date_unavailable,e.selectable=u,0===a?e["class"].push(this.appointmentsData.fully_scheduled_days[p]?"fully_scheduled":"not_appointable"):this.appointmentsData.fully_scheduled_days[p]&&this.appointmentsData.fully_scheduled_days[p][a]&&e["class"].push(this.appointmentsData.fully_scheduled_days[p][a]?"fully_scheduled":"not_appointable")),e},moment.locale(t),(wc_appointments_date_picker=o).init()});